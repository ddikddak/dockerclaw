---
plan_id: 03-01
phase: 03-actions-webhooks
wave: 1
autonomous: true
gap_closure: false
checkpoints: []
files_modified: []
estimated_tasks: 10
---

# Plan: 03-Actions & Webhooks

## Objective
Implementar sistema complet d'accions per tancar el loop Agent ‚Üî Human, amb Next.js API Routes i polling.

## Context
- Fase 01: Backend Express (ha de migrar-se a Next.js API Routes)
- Fase 02: Frontend Canvas + Kanbar (funcionant)
- Ara: Accions (approve, reject, edit, toggle) + polling per agents

## Tasks

### Task 1: Setup Next.js API Routes Structure
**Description:**
Migrar backend Express a Next.js API Routes.

**Commands:**
```bash
cd ~/projects/dockerclaw/dockerclaw-web
mkdir -p src/app/api/agents src/app/api/cards src/app/api/templates
npm install @supabase/supabase-js zod
```

**Files to create:**
- `src/lib/supabase.ts` - Client Supabase
- `src/lib/prisma.ts` - Client Prisma (si cal)
- `src/lib/validation.ts` - Zod schemas
- `src/middleware.ts` - Auth middleware (API keys)

**Acceptance Criteria:**
- [ ] Estructura d'API Routes creada
- [ ] Connexi√≥ a Supabase funciona
- [ ] Middleware d'autenticaci√≥ configurat

### Task 2: Migrar Endpoints Express a API Routes
**Description:**
Migrar endpoints existents de Express a Next.js App Router.

**Endpoints a migrar:**
- `GET /api/templates` ‚Üí `src/app/api/templates/route.ts`
- `POST /api/templates` ‚Üí `src/app/api/templates/route.ts`
- `GET /api/cards` ‚Üí `src/app/api/cards/route.ts`
- `POST /api/cards` ‚Üí `src/app/api/cards/route.ts`
- `GET /api/agents/:id/events` ‚Üí `src/app/api/agents/[id]/events/route.ts`

**Acceptance Criteria:**
- [ ] Tots els endpoints funcionen via API Routes
- [ ] Postman/curl tests passen
- [ ] Backend Express pot apagar-se

### Task 3: Crear Taula Actions a Supabase
**Description:**
Afegir taula per guardar accions dels humans.

**Schema:**
```sql
create table actions (
  id uuid primary key default gen_random_uuid(),
  card_id uuid references cards(id),
  agent_id uuid references agents(id),
  type text check (type in ('card_action', 'component_action')),
  action text not null,
  payload jsonb default '{}',
  status text default 'pending' check (status in ('pending', 'processed')),
  created_at timestamp default now()
);
```

**Acceptance Criteria:**
- [ ] Taula actions creada a Supabase
- [ ] Migracions aplicades
- [ ] Tipus TypeScript generats

### Task 4: Implementar Accions de Card
**Description:**
Endpoint per accions a nivell de card (approve, reject, delete, move).

**File:** `src/app/api/cards/[id]/actions/route.ts`

**Accions suportades:**
- `approve` ‚Üí status: 'approved'
- `reject` ‚Üí status: 'rejected'
- `delete` ‚Üí soft delete
- `move` ‚Üí canviar columna

**Acceptance Criteria:**
- [ ] Endpoint accepta POST amb {action, payload}
- [ ] Actualitza card.status
- [ ] Crea entrada a taula actions

### Task 5: Implementar Accions de Component
**Description:**
Endpoint per accions a nivell de component (edit_text, toggle_check).

**File:** `src/app/api/cards/[id]/components/[componentId]/actions/route.ts`

**Accions suportades:**
- `edit_text` ‚Üí update card.data.text
- `toggle_check` ‚Üí toggle checklist item
- `add_comment` ‚Üí afegir comentari

**Acceptance Criteria:**
- [ ] Endpoint accepta POST
- [ ] Actualitza card.data espec√≠fic
- [ ] Crea entrada a taula actions

### Task 6: Polling Endpoint per Agents
**Description:**
Endpoint GET per agents rebre accions pendents.

**File:** `src/app/api/agents/[id]/events/route.ts`

**Features:**
- Query param: `?since=timestamp` (optimitzaci√≥)
- Retorna accions amb status='pending'
- Marca com 'processed' quan l'agent les rep

**Acceptance Criteria:**
- [ ] Endpoint retorna accions pendents
- [ ] Marca accions com processed
- [ ] Suporta long-polling (opcional)

### Task 7: Frontend - In-Place Editing
**Description:**
Implementar edici√≥ in-place de text i code al frontend.

**Files:**
- `src/components/card/TextComponent.tsx` (afegir edici√≥)
- `src/components/card/CodeComponent.tsx` (afegir edici√≥)

**Features:**
- Doble clic per editar
- Guardar amb Enter/Ctrl+S
- Cancel¬∑lar amb Escape
- POST a API quan es guarda

**Acceptance Criteria:**
- [ ] Text editable in-place
- [ ] Code editable in-place
- [ ] Changes persistits a backend

### Task 8: Frontend - Botons d'Accions
**Description:**
Afegir botons approve/reject/delete visibles a les cards.

**File:** `src/components/Card.tsx`

**Botons:**
- ‚úÖ Approve (green)
- ‚ùå Reject (red)
- üóëÔ∏è Delete (gray)
- üìã Archive (opcional)

**Acceptance Criteria:**
- [ ] Botons visibles a hover o sempre
- [ ] Click executa acci√≥
- [ ] Card s'actualitza visualment

### Task 9: Frontend - Toggle Checkboxes
**Description:**
Checklist items toggleables directament.

**File:** `src/components/card/ChecklistComponent.tsx`

**Features:**
- Click checkbox per toggle
- POST immediat a backend
- Optimistic update (UI first)

**Acceptance Criteria:**
- [ ] Checkboxes toggleables
- [ ] Sync amb backend
- [ ] Animaci√≥ suau

### Task 10: Testing & Documentaci√≥
**Description:**
Testing complet i documentaci√≥ per agents.

**Tasks:**
- [ ] Test totes les accions amb curl/Postman
- [ ] Test flow complet: crear card ‚Üí acci√≥ ‚Üí polling
- [ ] Escriure `API.md` per agents externs
- [ ] Exemples de curl per cada endpoint
- [ ] Update `nestor-memory.md`

**Documentaci√≥ agent ha d'incloure:**
- Com registrar-se (get API key)
- Com crear template
- Com crear card
- Com fer polling d'events
- Format de payloads

## Rollback Strategy
Si algo falla:
1. Mantenir backend Express funcionant (no apagar fins confirmar)
2. Feature flags per desactivar accions noves
3. Fallback a polling cada 10s si SSE falla

## Definition of Done
- [ ] Tots els endpoints funcionen
- [ ] Accions de card funcionen (approve, reject, move, delete)
- [ ] Accions de component funcionen (edit, toggle)
- [ ] Polling funciona per agents
- [ ] Frontend t√© in-place editing
- [ ] Frontend t√© botons d'accions
- [ ] Documentaci√≥ completa per agents
- [ ] Tests passen
- [ ] Deploy a Vercel funciona
